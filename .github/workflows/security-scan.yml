name: Security Vulnerability Scan

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'

env:
  PYTHON_VERSION: '3.11'

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit
        run: |
          pip-audit --requirement requirements.txt --format json --output pip-audit-report.json || true
          pip-audit --requirement requirements.txt

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: pip-audit-report.json
          retention-days: 30

      - name: Install Safety
        run: |
          pip install safety

      - name: Run Safety check
        run: |
          safety check --json --output safety-report.json || true
          safety check --file requirements.txt

      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-report
          path: safety-report.json
          retention-days: 30

  code-security-scan:
    name: Code Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          bandit -r src/ -f json -o bandit-security-report.json || true
          bandit -r src/ -ll -iii

      - name: Upload Bandit security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-security-report.json
          retention-days: 30

  terraform-security-scan:
    name: Terraform Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Install Checkov
        run: |
          pip install checkov

      - name: Run TFLint
        run: |
          cd terraform
          tflint --init
          tflint --format json --out tflint-report.json || true
          tflint

      - name: Upload TFLint report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: tflint-report
          path: terraform/tflint-report.json
          retention-days: 30

      - name: Run Checkov
        run: |
          checkov -d terraform/ --framework terraform --output json --output-file-path checkov-report.json || true
          checkov -d terraform/ --framework terraform

      - name: Upload Checkov report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-report
          path: checkov-report.json
          retention-days: 30

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          version: latest

      - name: Run Gitleaks
        run: |
          gitleaks detect --source . --verbose --report-path gitleaks-report.json || true
          gitleaks detect --source . --verbose

      - name: Upload Gitleaks report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

      - name: Install TruffleHog
        run: |
          pip install truffleHog

      - name: Run TruffleHog scan
        run: |
          trufflehog filesystem --directory . --json --output trufflehog-report.json || true
          trufflehog filesystem --directory . || true

      - name: Upload TruffleHog report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trufflehog-report
          path: trufflehog-report.json
          retention-days: 30

